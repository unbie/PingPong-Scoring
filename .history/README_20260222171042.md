# 乒乓球计分器

## 项目简介

乒乓球计分器是一款基于计算机视觉和语音识别技术的创新型应用，旨在为乒乓球比赛提供自动化的计分和实时反馈功能。通过摄像头和麦克风，系统能够实时检测选手的手势和语音指令，自动更新比分并提供语音播报和视觉反馈。系统支持多局制比赛，具备总局比分追踪功能，适合正式比赛场景使用。

## 功能特点

- **手势识别**：利用 MediaPipe Hands 技术，实时检测选手的"摸球桌"手势以判断得分。检测逻辑严格，需同时满足以下4个条件，有效防止误判：
  - 手掌朝下（掌心低于手腕）
  - 至少3根手指伸展（非握拳/抓球状态）
  - 手位于画面下半部分（靠近桌面区域）
  - 指尖低于手腕（确认向下触摸动作）
- **语音识别**：通过 Google Speech API 同时识别中英文语音指令，只需简短地喊出 **"A"** 或 **"B"**，系统自动为对应选手计分。支持多种发音变体（如"诶"、"哎"代表A，"比"、"币"代表B），中英双语均可触发。（这里建议使用A得分，B得分，识别率高）
- **实时比分显示**：通过 OpenCV 实现高对比度、自适应大字体的实时比分显示，支持全屏模式，方便远距离观看。
- **得分闪烁动画**：得分瞬间，得分方面板自动高亮闪烁，直观提示得分事件。
- **多局制比赛**：支持7局4胜赛制，系统自动追踪每局比分与总局比分，单局结束后自动重置当局比分并继续比赛，全场获胜后显示比赛结束画面。
- **发球方提示**：系统自动提示当前发球方，界面显示发球方球形图标并通过语音播报。
- **比赛规则自动化**：支持11分制规则，每得2分自动切换发球方，支持平局延分规则（领先2分获胜）。
- **防误判机制**：设置冷却时间（默认3秒），避免连续重复计分。

## 技术架构

- **前端/UI**：基于 OpenCV 和半透明面板叠加实现的实时美化图形界面，支持全屏显示。
- **后端逻辑**：使用 Python 和 NumPy 处理数据和实现比赛逻辑，含多局制总分追踪。
- **手势识别**：采用 MediaPipe Hands 进行21个关键点检测，多条件联合判断防止误判。
- **语音识别**：集成 SpeechRecognition 库，使用 Google Speech API 同时识别中文（zh-CN）和英文（en-US），并采用多候选结果（show_all）模式提升识别率。
- **语音播报**：通过 pyttsx3 实现实时语音播报，每次播报独立新建引擎实例，解决跨线程状态残留问题。
- **开发语言**：Python 3.7+

## 安装与运行

### 环境要求

1. **操作系统**：Windows 10 或更高版本。
2. **Python版本**：Python 3.7 或更高。
3. **硬件要求**：
   - 摄像头：支持高清拍摄（推荐 1280×720）。
   - 麦克风：支持清晰的语音输入。

### 安装步骤

1. 克隆项目代码：
   ```bash
   git clone https://github.com/unbie/table_tennis.git
   cd table_tennis
   ```
2. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
3. 运行主程序：
   ```bash
   python main_table_tennis_scorer.py
   ```

## 使用说明

### 控制方式

- **手势识别**：
  - 将手置于画面下半部，手掌朝下并伸展手指做"触摸桌面"手势以记录得分。
  - 左侧（画面中x < 50%）判定为A得分，右侧判定为B得分。
- **语音识别**：
  - 通过麦克风喊出 **"A"**（或"诶"、"哎"等）为A方计分。
  - 通过麦克风喊出 **"B"**（或"比"、"币"等）为B方计分。
  - 无需说完整句子，单个音节即可触发识别。
- **键盘控制**：
  | 按键 | 功能 |
  |------|------|
  | `q` | 退出程序 |
  | `r` | 重置当前局比分（保留总局比分） |
  | `f` | 全局重置（清空当前局及总局比分） |
  | `a` | A方手动 +1 分 |
  | `s` | A方手动 -1 分 |
  | `b` | B方手动 +1 分 |
  | `n` | B方手动 -1 分 |

### 比赛规则

- 采用11分制，需领先2分获胜（支持平局延分）。
- 每得2分后交换发球权。
- 得分后有3秒冷却期，防止重复计分。
- 单局结束后自动重置当局比分并继续下一局，先赢得4局者获得全场胜利（7局4胜制）。

## 配置文件

用户可以通过修改 [config.py](./config.py) 文件自定义以下参数：

- **摄像头设置**：分辨率（默认1280×720）、摄像头索引等。
- **手势识别灵敏度**：手部检测置信度、追踪置信度、最大检测手数等。
- **语音识别参数**：音量阈值、最长录音时间、关键词列表等。
- **比赛规则**：得分上限（默认11分）、发球轮换间隔（默认每2分换发）、最小获胜分差（默认2分）。
- **UI显示设置**：字体大小、各区域颜色、得分闪烁持续时间等。
- **全屏显示**：`WINDOW_FULLSCREEN = True` 开启全屏（默认开启，方便远距离观看）。
- **调试模式**：`DEBUG_MODE` 开关调试输出；`LOG_TO_FILE` 控制是否将得分记录写入 `scoring_log.txt`。

## 注意事项

- 确保光线充足，摄像头视野清晰，有助于提高手势识别准确率。
- 语音识别功能需要稳定的互联网连接（使用 Google Speech API）。
- 在安静的环境中使用语音识别功能以提高准确性；程序启动时会自动对麦克风进行1秒环境噪声校准。
- 如果在Windows系统上出现中文乱码问题，请参考以下解决方案：
  1. 设置控制台代码页为UTF-8：
     ```cmd
     chcp 65001
     ```
  2. 在Python运行时指定编码：
     ```cmd
     python -X utf8 main_table_tennis_scorer.py
     ```
  3. 设置环境变量：
     ```cmd
     set PYTHONIOENCODING=utf-8
     python main_table_tennis_scorer.py
     ```

## 已知问题

- 光线不足时，手势识别可能不稳定。
- 语音识别对背景噪音较为敏感。
- 多人场景下的识别精度有待优化。
- Windows系统下可能出现中文显示问题（见注意事项）。

## 开发计划

1. 增加更多的手势识别类型（如挥拍动作）。
2. 提供更灵活的语音关键词配置，支持本地离线语音识别。
3. 增加网络功能，支持远程计分和观赛。
4. 添加比赛回放和统计功能（得分时间轴、胜率分析等）。
5. 优化语音识别的背景噪音处理。
6. 支持自定义赛制（如21分制、局数配置等）。

## 贡献

非专业程序员，自用而开发。  
欢迎对本项目提出建议或贡献代码，提交 Issue 或 Pull Request。

## 许可证

本项目基于 MIT 许可证开源，详情请参阅 [LICENSE](./LICENSE)。
